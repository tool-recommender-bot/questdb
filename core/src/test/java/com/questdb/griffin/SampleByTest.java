/*******************************************************************************
 *    ___                  _   ____  ____
 *   / _ \ _   _  ___  ___| |_|  _ \| __ )
 *  | | | | | | |/ _ \/ __| __| | | |  _ \
 *  | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *   \__\_\\__,_|\___||___/\__|____/|____/
 *
 * Copyright (C) 2014-2018 Appsicle
 *
 * This program is free software: you can redistribute it and/or  modify
 * it under the terms of the GNU Affero General Public License, version 3,
 * as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 ******************************************************************************/

package com.questdb.griffin;

import com.questdb.griffin.engine.functions.rnd.SharedRandom;
import com.questdb.std.Rnd;
import org.junit.Before;
import org.junit.Test;

public class SampleByTest extends AbstractGriffinTest {
    @Before
    public void setUp3() {
        SharedRandom.RANDOM.set(new Rnd());
    }

    @Test
    public void testSample() throws Exception {
        assertQuery("b\tsum\tk\n" +
                        "\t11.427984775756\t1970-01-03T00:00:00.000000Z\n" +
                        "VTJW\t42.177688419694\t1970-01-03T00:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T00:00:00.000000Z\n" +
                        "PEHN\t0.000000000000\t1970-01-03T00:00:00.000000Z\n" +
                        "HYRX\t0.000000000000\t1970-01-03T00:00:00.000000Z\n" +
                        "\t120.878116330711\t1970-01-03T03:00:00.000000Z\n" +
                        "VTJW\t42.177688419694\t1970-01-03T03:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T03:00:00.000000Z\n" +
                        "PEHN\t70.943604871712\t1970-01-03T03:00:00.000000Z\n" +
                        "HYRX\t0.000000000000\t1970-01-03T03:00:00.000000Z\n" +
                        "\t57.934663268622\t1970-01-03T06:00:00.000000Z\n" +
                        "VTJW\t42.177688419694\t1970-01-03T06:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T06:00:00.000000Z\n" +
                        "PEHN\t81.468079445006\t1970-01-03T06:00:00.000000Z\n" +
                        "HYRX\t97.711031460512\t1970-01-03T06:00:00.000000Z\n" +
                        "\t26.922103479745\t1970-01-03T09:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T09:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T09:00:00.000000Z\n" +
                        "PEHN\t81.468079445006\t1970-01-03T09:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T09:00:00.000000Z\n" +
                        "\t150.486047954871\t1970-01-03T12:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T12:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T12:00:00.000000Z\n" +
                        "PEHN\t84.452581772111\t1970-01-03T12:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T12:00:00.000000Z\n" +
                        "\t172.061250867250\t1970-01-03T15:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T15:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T15:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-03T15:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T15:00:00.000000Z\n" +
                        "\t86.089926708847\t1970-01-03T18:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T18:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T18:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-03T18:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T18:00:00.000000Z\n",
                "select b, sum(a), k from x sample by 3h",
                "create table x as " +
                        "(" +
                        "select" +
                        " rnd_double(0)*100 a," +
                        " rnd_symbol(5,4,4,1) b," +
                        " timestamp_sequence(to_timestamp(172800000000), 3600000000) k" +
                        " from" +
                        " long_sequence(20)" +
                        ") timestamp(k) partition by NONE",
                "k",
                "insert into x select * from (" +
                        "select" +
                        " rnd_double(0)*100 a," +
                        " rnd_symbol(5,4,4,1) b," +
                        " timestamp_sequence(to_timestamp(277200000000), 3600000000) k" +
                        " from" +
                        " long_sequence(5)" +
                        ") timestamp(k)",
                "b\tsum\tk\n" +
                        "\t11.427984775756\t1970-01-03T00:00:00.000000Z\n" +
                        "VTJW\t42.177688419694\t1970-01-03T00:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T00:00:00.000000Z\n" +
                        "PEHN\t0.000000000000\t1970-01-03T00:00:00.000000Z\n" +
                        "HYRX\t0.000000000000\t1970-01-03T00:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-03T00:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-03T00:00:00.000000Z\n" +
                        "\t120.878116330711\t1970-01-03T03:00:00.000000Z\n" +
                        "VTJW\t42.177688419694\t1970-01-03T03:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T03:00:00.000000Z\n" +
                        "PEHN\t70.943604871712\t1970-01-03T03:00:00.000000Z\n" +
                        "HYRX\t0.000000000000\t1970-01-03T03:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-03T03:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-03T03:00:00.000000Z\n" +
                        "\t57.934663268622\t1970-01-03T06:00:00.000000Z\n" +
                        "VTJW\t42.177688419694\t1970-01-03T06:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T06:00:00.000000Z\n" +
                        "PEHN\t81.468079445006\t1970-01-03T06:00:00.000000Z\n" +
                        "HYRX\t97.711031460512\t1970-01-03T06:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-03T06:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-03T06:00:00.000000Z\n" +
                        "\t26.922103479745\t1970-01-03T09:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T09:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T09:00:00.000000Z\n" +
                        "PEHN\t81.468079445006\t1970-01-03T09:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T09:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-03T09:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-03T09:00:00.000000Z\n" +
                        "\t150.486047954871\t1970-01-03T12:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T12:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T12:00:00.000000Z\n" +
                        "PEHN\t84.452581772111\t1970-01-03T12:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T12:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-03T12:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-03T12:00:00.000000Z\n" +
                        "\t172.061250867250\t1970-01-03T15:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T15:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T15:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-03T15:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T15:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-03T15:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-03T15:00:00.000000Z\n" +
                        "\t86.089926708847\t1970-01-03T18:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T18:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T18:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-03T18:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T18:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-03T18:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-03T18:00:00.000000Z\n" +
                        "\t86.089926708847\t1970-01-03T21:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-03T21:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-03T21:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-03T21:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-03T21:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-03T21:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-03T21:00:00.000000Z\n" +
                        "\t86.089926708847\t1970-01-04T00:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-04T00:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-04T00:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-04T00:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-04T00:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-04T00:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-04T00:00:00.000000Z\n" +
                        "\t54.491550215189\t1970-01-04T03:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-04T03:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-04T03:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-04T03:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-04T03:00:00.000000Z\n" +
                        "UVSD\t0.000000000000\t1970-01-04T03:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-04T03:00:00.000000Z\n" +
                        "\t135.835983782176\t1970-01-04T06:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-04T06:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-04T06:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-04T06:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-04T06:00:00.000000Z\n" +
                        "UVSD\t49.428905119585\t1970-01-04T06:00:00.000000Z\n" +
                        "KGHV\t0.000000000000\t1970-01-04T06:00:00.000000Z\n" +
                        "\t135.835983782176\t1970-01-04T09:00:00.000000Z\n" +
                        "VTJW\t48.820511018587\t1970-01-04T09:00:00.000000Z\n" +
                        "RXGZ\t23.905290108465\t1970-01-04T09:00:00.000000Z\n" +
                        "PEHN\t49.005104498852\t1970-01-04T09:00:00.000000Z\n" +
                        "HYRX\t12.026122412833\t1970-01-04T09:00:00.000000Z\n" +
                        "UVSD\t49.428905119585\t1970-01-04T09:00:00.000000Z\n" +
                        "KGHV\t67.525095471124\t1970-01-04T09:00:00.000000Z\n",
                false);
    }
}
